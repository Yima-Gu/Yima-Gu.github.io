

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/my_icon.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Yima Gu">
  <meta name="keywords" content="">
  
    <meta name="description" content="计算机体系结构: ISA (Instruction Set Architecture)              主要内容：本章从使用汇编转向了设计 CPU。ISA (指令集架构)：介绍了 ISA 作为软硬件契约的概念，以及 CISC (x86) 与 RISC (ARM&#x2F;MIPS) 的设计哲学区别。Y86-64：为了教学目的，简化了复杂的 x86-64，定义了一个迷你的指令集 Y86-64。我们详">
<meta property="og:type" content="article">
<meta property="og:title" content="CSAPP - 04.ISA">
<meta property="og:url" content="https://yima-gu.github.io/2026/01/14/CSAPP/04-ISA/index.html">
<meta property="og:site_name" content="Yima Gu&#39;s Blog">
<meta property="og:description" content="计算机体系结构: ISA (Instruction Set Architecture)              主要内容：本章从使用汇编转向了设计 CPU。ISA (指令集架构)：介绍了 ISA 作为软硬件契约的概念，以及 CISC (x86) 与 RISC (ARM&#x2F;MIPS) 的设计哲学区别。Y86-64：为了教学目的，简化了复杂的 x86-64，定义了一个迷你的指令集 Y86-64。我们详">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2026-01-14T18:05:00.000Z">
<meta property="article:modified_time" content="2026-01-15T02:21:02.349Z">
<meta property="article:author" content="Yima Gu">
<meta property="article:tag" content="CSAPP">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>CSAPP - 04.ISA - Yima Gu&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/KaTeX/0.16.2/katex.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"yima-gu.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":"G-JFL0C5NV2V","tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  



  
<meta name="generator" content="Hexo 8.1.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Yima Gu&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg/post.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="CSAPP - 04.ISA"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2026-01-15 02:05" pubdate>
          2026年1月15日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          4.4k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          37 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">CSAPP - 04.ISA</h1>
            
            
              <div class="markdown-body">
                
                <h1>计算机体系结构: ISA (Instruction Set Architecture)</h1>
<div class="note note-success 核心导读：定义硬件与软件的接口">
            <p><strong>主要内容</strong>：<br>本章从使用汇编转向了<strong>设计 CPU</strong>。</p><ol><li><strong>ISA (指令集架构)</strong>：介绍了 ISA 作为软硬件契约的概念，以及 CISC (x86) 与 RISC (ARM/MIPS) 的设计哲学区别。</li><li><strong>Y86-64</strong>：为了教学目的，简化了复杂的 x86-64，定义了一个迷你的指令集 Y86-64。我们详细定义了它的寄存器、指令编码字节、以及异常处理状态。</li></ol><p><strong>Motivation</strong>：<br>真正的 x86-64 太复杂，无法在课堂上设计出它的电路。学习 Y86-64 是为了搭建一个**“麻雀虽小，五脏俱全”的模型**。它是后续章节我们亲手“造 CPU”的蓝图和需求文档。</p>
          </div>
<h2 id="指令集架构-Instruction-Set-Architecture-ISA">指令集架构 (Instruction Set Architecture - ISA)</h2>
<ul>
<li><strong>ISA (指令集架构)</strong> 是一个抽象层，位于编译器编写者和处理器设计者之间。</li>
<li>它定义了处理器的<strong>汇编语言视图 (Assembly Language View)</strong>：
<ul>
<li><strong>处理器状态 (Processor state):</strong> 寄存器、内存等。</li>
<li><strong>指令 (Instructions):</strong> <code>addq</code>, <code>pushq</code>, <code>ret</code> 等。</li>
<li><strong>指令编码 (Encoding):</strong> 指令如何被编码为字节。</li>
</ul>
</li>
</ul>
<p><strong>抽象层次：</strong></p>
<ul>
<li><strong>对编译器编写者 (上层):</strong>
<ul>
<li>只需要知道允许哪些指令，以及它们是如何编码的。</li>
<li>关注机器代码优化。</li>
</ul>
</li>
<li><strong>对处理器设计者 (下层):</strong>
<ul>
<li>需要建造出能执行这些指令的处理器。</li>
<li>关注如何高效执行指令（例如，通过流水线并行执行）。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="CISC-vs-RISC">CISC vs. RISC</h2>
<h3 id="CISC-复杂指令集计算机">CISC (复杂指令集计算机)</h3>
<ul>
<li><strong>CISC</strong> = Complex Instruction Set Computer。</li>
<li><strong>IA32 (x86-32)</strong> 是一个典型的例子。</li>
<li><strong>特性:</strong>
<ul>
<li><strong>面向栈 (Stack-oriented):</strong> 使用栈来传递参数、保存程序计数器，有显式的 <code>push</code> 和 <code>pop</code> 指令。</li>
<li><strong>算术指令可访问内存:</strong> 例如 <code>addq %rax, 12(%rbx,%rcx,8)</code>，一条指令就包含了复杂的地址计算以及内存读写。</li>
<li><strong>条件码 (Condition codes):</strong> 作为算术和逻辑指令的副作用被设置。</li>
</ul>
</li>
<li><strong>哲学:</strong> 添加指令来执行“典型”的编程任务。</li>
<li><strong>结果:</strong> x86 指令集中的指令数量随时间不断增长，到 2014 年已超过 1300 条。</li>
</ul>
<h3 id="RISC-精简指令集计算机">RISC (精简指令集计算机)</h3>
<ul>
<li><strong>RISC</strong> = Reduced Instruction Set Computer。</li>
<li>由 IBM 的项目开创，后被 Hennessy (Stanford) 和 Patterson (Berkeley) 推广。</li>
<li><strong>特性:</strong>
<ul>
<li><strong>更少、更简单的指令:</strong> 完成某个任务可能需要更多条指令，但每条指令都可以用更小、更快的硬件来执行。</li>
<li><strong>面向寄存器 (Register-oriented):</strong>
<ul>
<li>通常有更多（例如 32 个）寄存器。</li>
<li>使用寄存器传递参数、存储返回值和临时变量。</li>
</ul>
</li>
<li><strong>Load/Store 架构:</strong>
<ul>
<li><strong>只有 <code>load</code> (加载) 和 <code>store</code> (存储) 指令可以访问内存</strong>（类似于 Y86-64 的 <code>mrmovq</code> 和 <code>rmmovq</code>）。</li>
<li>算术指令（如 <code>add</code>）只能操作寄存器。</li>
</ul>
</li>
<li><strong>无条件码:</strong> 测试指令（如比较）会在一个寄存器中返回 0 或 1。</li>
</ul>
</li>
</ul>
<h4 id="MIPS-示例-一种-RISC-ISA">MIPS 示例 (一种 RISC ISA)</h4>
<ul>
<li><strong>MIPS 寄存器:</strong> 有 32 个通用寄存器（<code>$0</code> - <code>$31</code>），按用途命名（如 <code>$a0</code> - <code>$a3</code> 用于参数，<code>$v0</code> - <code>$v1</code> 用于返回值，<code>$t0</code> - <code>$t9</code> 用于临时变量，<code>$s0</code> - <code>$s7</code> 用于保存的变量，<code>$sp</code> 栈指针，<code>$ra</code> 返回地址）。</li>
<li><strong>MIPS 指令示例:</strong>
<ul>
<li><code>addu $3, $2, $1</code> (寄存器加法): <code>$3 = $2 + $1</code></li>
<li><code>addu $3, $2, 3145</code> (立即数加法: <code>$3 = $2 + 3145</code>)</li>
<li><code>lw $3, 16($2)</code> (Load Word: <code>$3 = M[$2 + 16]</code>)</li>
<li><code>sw $3, 16($2)</code> (Store Word: <code>M[$2 + 16] = $3</code>)</li>
</ul>
</li>
</ul>
<h3 id="CISC-vs-RISC-的现状">CISC vs. RISC 的现状</h3>
<ul>
<li>
<p><strong>最初的争论:</strong></p>
<ul>
<li><strong>CISC 支持者:</strong> 对编译器友好，代码字节数更少。</li>
<li><strong>RISC 支持者:</strong> 对优化编译器友好，可以用简单的芯片设计实现高速运行。</li>
</ul>
</li>
<li>
<p><strong>目前的状态:</strong></p>
<ul>
<li><strong>桌面处理器:</strong> ISA 的选择已不是一个关键技术问题。有足够强大的硬件，任何 ISA 都能跑得很快。<strong>代码兼容性</strong>更重要。</li>
<li><strong>x86-64</strong> 已经吸收了很多 <strong>RISC 的特性</strong>（例如，更多的寄存器，使用寄存器传参）。</li>
<li><strong>嵌入式处理器:</strong> RISC 意义重大（更小、更便宜、功耗更低）。<strong>ARM</strong> 处理器（一种 RISC）被用于大多数手机。</li>
</ul>
</li>
<li>
<p><strong>总结:</strong> 无论是单纯的 RISC 还是 CISC 都不如结合两者思想精华的设计。Y86-64 就同时具有 CISC（如条件码、可变指令长度）和 RISC（如 Load/Store 体系结构）的属性。</p>
</li>
</ul>
<hr>
<h2 id="Y86-64-处理器状态-Processor-State">Y86-64 处理器状态 (Processor State)</h2>
<ul>
<li><strong>RF (Program Registers):</strong> 15 个程序寄存器（省略 <code>%r15</code>），每个 64 位。</li>
<li><strong>CC (Condition Codes):</strong> 3 个单位标志位：
<ul>
<li><code>ZF</code>: 零 (Zero)</li>
<li><code>SF</code>: 负 (Negative)</li>
<li><code>OF</code>: 溢出 (Overflow)</li>
</ul>
</li>
<li><strong>PC (Program Counter):</strong> 存放下一条要执行指令的地址。</li>
<li><strong>Stat (Program Status):</strong> 指示程序是正常运行还是出现了错误。</li>
<li><strong>DMEM (Memory):</strong> 字节寻址的存储阵列。</li>
</ul>
<h2 id="Y86-64-指令集-Instruction-Set">Y86-64 指令集 (Instruction Set)</h2>
<ul>
<li><strong>格式:</strong> 指令长度为 1 到 10 字节。可以从第一个字节确定指令长度。编码比 x86-64 简单。</li>
<li><strong>字节编码的唯一解释</strong>：这是指令集的一个重要性质。
<ul>
<li>任意一个字节序列要么是一个唯一的指令序列的编码，要么就不是一个合法的字节序列。</li>
<li>这保证了处理器可以无二义性地执行目标代码程序。</li>
</ul>
</li>
<li><strong>第一个字节</strong>：Y86-64 每条指令的第一个字节有唯一的<strong>代码 (icode)</strong> 和<strong>功能 (ifun)</strong> 组合。
<ul>
<li>给定这个字节，我们就可以决定所有其他附加字节的长度和含义。</li>
</ul>
</li>
<li><strong>字节序</strong>：Y86-64 采用<strong>小端法 (little-endian)</strong>，同 x86-64 一样。</li>
</ul>
<h3 id="寄存器编码-Encoding-Registers">寄存器编码 (Encoding Registers)</h3>
<ul>
<li>每个寄存器有一个 4-bit 的 ID (0-E)。</li>
<li>ID <strong><code>F</code> (15)</strong> 表示 <strong>“无寄存器” (No Register)</strong>。</li>
</ul>
<table>
<thead>
<tr>
<th><strong>寄存器</strong></th>
<th><strong>ID</strong></th>
<th><strong>寄存器</strong></th>
<th><strong>ID</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>%rax</code></td>
<td>0</td>
<td><code>%r8</code></td>
<td>8</td>
</tr>
<tr>
<td><code>%rcx</code></td>
<td>1</td>
<td><code>%r9</code></td>
<td>9</td>
</tr>
<tr>
<td><code>%rdx</code></td>
<td>2</td>
<td><code>%r10</code></td>
<td>A</td>
</tr>
<tr>
<td><code>%rbx</code></td>
<td>3</td>
<td><code>%r11</code></td>
<td>B</td>
</tr>
<tr>
<td><code>%rsp</code></td>
<td>4</td>
<td><code>%r12</code></td>
<td>C</td>
</tr>
<tr>
<td><code>%rbp</code></td>
<td>5</td>
<td><code>%r13</code></td>
<td>D</td>
</tr>
<tr>
<td><code>%rsi</code></td>
<td>6</td>
<td><code>%r14</code></td>
<td>E</td>
</tr>
<tr>
<td><code>%rdi</code></td>
<td>7</td>
<td>(无)</td>
<td>F</td>
</tr>
</tbody>
</table>
<h3 id="Y86-64-指令详解">Y86-64 指令详解</h3>
<h4 id="1-算术和逻辑操作-Arithmetic-and-Logical-Operations">1. 算术和逻辑操作 (Arithmetic and Logical Operations)</h4>
<ul>
<li><code>OPq rA, rB</code> (编码: <code>6 fn rA rB</code>)</li>
<li>从 <code>rA</code> 和 <code>rB</code> 读取值，计算结果，存回 <code>rB</code>，并设置条件码。</li>
<li><code>fn</code> (function code) 决定具体操作：
<ul>
<li><code>addq</code> (加法): <code>fn = 0</code> (编码: <code>60</code>)</li>
<li><code>subq</code> (减法): <code>fn = 1</code> (编码: <code>61</code>)</li>
<li><code>andq</code> (与): <code>fn = 2</code> (编码: <code>62</code>)</li>
<li><code>xorq</code> (异或): <code>fn = 3</code> (编码: <code>63</code>)</li>
</ul>
</li>
<li><strong>示例:</strong> <code>addq %rax, %rsi</code>
<ul>
<li><code>rA = %rax = 0</code>, <code>rB = %rsi = 6</code></li>
<li>编码: <code>60 06</code></li>
</ul>
</li>
</ul>
<h4 id="2-移动操作-Move-Operations">2. 移动操作 (Move Operations)</h4>
<ul>
<li><code>rrmovq rA, rB</code> (编码: <code>20 rA rB</code>)
<ul>
<li>寄存器 -&gt; 寄存器。</li>
</ul>
</li>
<li><code>irmovq V, rB</code> (编码: <code>30 F rB V</code>)
<ul>
<li>立即数 -&gt; 寄存器。<code>V</code> 是一个 8 字节的立即数。</li>
</ul>
</li>
<li><code>rmmovq rA, D(rB)</code> (编码: <code>40 rA rB D</code>)
<ul>
<li>寄存器 -&gt; 内存。<code>D</code> 是一个 8 字节的位移。</li>
</ul>
</li>
<li><code>mrmovq D(rB), rA</code> (编码: <code>50 rA rB D</code>)
<ul>
<li>内存 -&gt; 寄存器。<code>D</code> 是一个 8 字节的位移。</li>
</ul>
</li>
<li><strong>示例:</strong> <code>irmovq $0xabcd, %rdx</code>
<ul>
<li><code>rB = %rdx = 2</code>, <code>V = 0x...abcd</code></li>
<li>编码: <code>30 f2 cd ab 00 00 00 00 00 00</code> (小端法)</li>
</ul>
</li>
<li><strong>示例:</strong> <code>rmmovq %rsi, 0x41c(%rsp)</code>
<ul>
<li><code>rA = %rsi = 6</code>, <code>rB = %rsp = 4</code>, <code>D = 0x...41c</code></li>
<li>编码: <code>40 64 1c 04 00 00 00 00 00 00</code></li>
</ul>
</li>
</ul>
<h4 id="3-条件移动-Conditional-Move-Instructions">3. 条件移动 (Conditional Move Instructions)</h4>
<ul>
<li><code>cmovXX rA, rB</code> (编码: <code>2 fn rA rB</code>)</li>
<li>这是 <code>rrmovq</code> 的变体。只有当条件码满足 <code>fn</code> 指定的条件时，才将 <code>rA</code> 的值复制到 <code>rB</code>。</li>
<li><code>fn</code> (function code) 决定条件：
<ul>
<li><code>rrmovq</code> (无条件): <code>fn = 0</code> (编码: <code>20</code>)</li>
<li><code>cmovle</code> (小于或等于): <code>fn = 1</code> (编码: <code>21</code>)</li>
<li><code>cmovl</code> (小于): <code>fn = 2</code> (编码: <code>22</code>)</li>
<li><code>cmove</code> (等于): <code>fn = 3</code> (编码: <code>23</code>)</li>
<li><code>cmovne</code> (不等于): <code>fn = 4</code> (编码: <code>24</code>)</li>
<li><code>cmovge</code> (大于或等于): <code>fn = 5</code> (编码: <code>25</code>)</li>
<li><code>cmovg</code> (大于): <code>fn = 6</code> (编码: <code>26</code>)</li>
</ul>
</li>
</ul>
<h4 id="4-跳转指令-Jump-Instructions">4. 跳转指令 (Jump Instructions)</h4>
<ul>
<li><code>jXX Dest</code> (编码: <code>7 fn Dest</code>)</li>
<li>根据 <code>fn</code> 指定的条件码，跳转到 <code>Dest</code> (一个 8 字节的绝对地址)。</li>
<li><code>fn</code> (function code) 决定条件：
<ul>
<li><code>jmp</code> (无条件): <code>fn = 0</code> (编码: <code>70</code>)</li>
<li><code>jle</code> (小于或等于): <code>fn = 1</code> (编码: <code>71</code>)</li>
<li><code>jl</code> (小于): <code>fn = 2</code> (编码: <code>72</code>)</li>
<li><code>je</code> (等于): <code>fn = 3</code> (编码: <code>73</code>)</li>
<li><code>jne</code> (不等于): <code>fn = 4</code> (编码: <code>74</code>)</li>
<li><code>jge</code> (大于或等于): <code>fn = 5</code> (编码: <code>75</code>)</li>
<li><code>jg</code> (大于): <code>fn = 6</code> (编码: <code>76</code>)</li>
</ul>
</li>
</ul>
<h4 id="5-栈操作-Stack-Operations">5. 栈操作 (Stack Operations)</h4>
<ul>
<li>Y86-64 的栈向<strong>低地址</strong>增长。<code>%rsp</code> 指向栈顶元素。</li>
<li><code>pushq rA</code> (编码: <code>A0 rA F</code>)
<ol>
<li><code>%rsp</code> 减 8。</li>
<li>将 <code>rA</code> 的值存入 <code>%rsp</code> 指向的内存。</li>
</ol>
</li>
<li><code>popq rA</code> (编码: <code>B0 rA F</code>)
<ol>
<li>从 <code>%rsp</code> 指向的内存读取一个值存入 <code>rA</code>。</li>
<li><code>%rsp</code> 加 8。</li>
</ol>
</li>
</ul>
<h4 id="6-子程序调用和返回-Subroutine-Call-and-Return">6. 子程序调用和返回 (Subroutine Call and Return)</h4>
<ul>
<li><code>call Dest</code> (编码: <code>80 Dest</code>)
<ol>
<li>将 <code>call</code> 指令的下一条指令地址（返回地址）<code>push</code> 到栈上。</li>
<li>跳转到 <code>Dest</code>。</li>
</ol>
</li>
<li><code>ret</code> (编码: <code>90</code>)
<ol>
<li>从栈上 <code>pop</code> 一个地址。</li>
<li>跳转到该地址。</li>
</ol>
</li>
</ul>
<h4 id="7-杂项指令-Miscellaneous-Instructions">7. 杂项指令 (Miscellaneous Instructions)</h4>
<ul>
<li><code>nop</code> (编码: <code>10</code>)
<ul>
<li>不做任何事。</li>
</ul>
</li>
<li><code>halt</code> (编码: <code>00</code>)
<ul>
<li>停止执行指令。</li>
<li>编码为 <code>00</code> 确保了程序如果意外跳转到未初始化的内存（通常为 0）时会停止，而不是执行非法指令。</li>
</ul>
</li>
</ul>
<h3 id="状态条件-Status-Conditions">状态条件 (Status Conditions)</h3>
<ul>
<li><code>AOK</code> (Code 1): 正常操作。</li>
<li><code>HLT</code> (Code 2): <code>halt</code> 指令。</li>
<li><code>ADR</code> (Code 3): 遇到非法地址（指令或数据）。</li>
<li><code>INS</code> (Code 4): 遇到非法指令。</li>
<li>如果状态不是 <code>AOK</code>，处理器停止执行。</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">类别</th>
<th style="text-align:left">指令助记符 (Mnemonic)</th>
<th style="text-align:left">字节编码 (Byte Encoding)<br><code>icode:ifun</code> …</th>
<th style="text-align:left">长度 (Bytes)</th>
<th style="text-align:left">含义 / 操作描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>控制与杂项</strong></td>
<td style="text-align:left"><strong>halt</strong></td>
<td style="text-align:left"><code>00</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">停止指令执行。将状态码设置为 <code>HLT</code> 。</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"><strong>nop</strong></td>
<td style="text-align:left"><code>10</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">空操作，什么也不做 (No Operation) 。</td>
</tr>
<tr>
<td style="text-align:left"><strong>数据传送</strong></td>
<td style="text-align:left"><strong>rrmovq</strong> rA, rB</td>
<td style="text-align:left"><code>20 rA rB</code></td>
<td style="text-align:left">2</td>
<td style="text-align:left">寄存器到寄存器传送：<code>R[rB] &lt;- R[rA]</code>。</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"><strong>cmovXX</strong> rA, rB</td>
<td style="text-align:left"><code>2fn rA rB</code></td>
<td style="text-align:left">2</td>
<td style="text-align:left"><strong>条件传送</strong>：根据条件码决定是否将 <code>R[rA]</code> 传送到 <code>R[rB]</code>。<br> <code>21</code>: <strong>cmovle</strong> (&lt;=)<br> <code>22</code>: <strong>cmovl</strong> (&lt;)<br> <code>23</code>: <strong>cmove</strong> (=)<br> <code>24</code>: <strong>cmovne</strong> (!=)<br> <code>25</code>: <strong>cmovge</strong> (&gt;=)<br> <code>26</code>: <strong>cmovg</strong> (&gt;)</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"><strong>irmovq</strong> V, rB</td>
<td style="text-align:left"><code>30 F rB V</code></td>
<td style="text-align:left">10</td>
<td style="text-align:left">立即数到寄存器：<code>R[rB] &lt;- V</code>。注意源寄存器位固定为 <code>F</code> (无) 。</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"><strong>rmmovq</strong> rA, D(rB)</td>
<td style="text-align:left"><code>40 rA rB D</code></td>
<td style="text-align:left">10</td>
<td style="text-align:left">寄存器到内存：<code>M[R[rB] + D] &lt;- R[rA]</code> 。</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"><strong>mrmovq</strong> D(rB), rA</td>
<td style="text-align:left"><code>50 rA rB D</code></td>
<td style="text-align:left">10</td>
<td style="text-align:left">内存到寄存器：<code>R[rA] &lt;- M[R[rB] + D]</code>。</td>
</tr>
<tr>
<td style="text-align:left"><strong>算术逻辑</strong></td>
<td style="text-align:left"><strong>addq</strong> rA, rB</td>
<td style="text-align:left"><code>60 rA rB</code></td>
<td style="text-align:left">2</td>
<td style="text-align:left">加法：<code>R[rB] &lt;- R[rB] + R[rA]</code> 。</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"><strong>subq</strong> rA, rB</td>
<td style="text-align:left"><code>61 rA rB</code></td>
<td style="text-align:left">2</td>
<td style="text-align:left">减法：<code>R[rB] &lt;- R[rB] - R[rA]</code>。</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"><strong>andq</strong> rA, rB</td>
<td style="text-align:left"><code>62 rA rB</code></td>
<td style="text-align:left">2</td>
<td style="text-align:left">逻辑与：<code>R[rB] &lt;- R[rB] &amp; R[rA]</code>。</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"><strong>xorq</strong> rA, rB</td>
<td style="text-align:left"><code>63 rA rB</code></td>
<td style="text-align:left">2</td>
<td style="text-align:left">逻辑异或：<code>R[rB] &lt;- R[rB] ^ R[rA]</code>。</td>
</tr>
<tr>
<td style="text-align:left"><strong>跳转控制</strong></td>
<td style="text-align:left"><strong>jmp</strong> Dest</td>
<td style="text-align:left"><code>70 Dest</code></td>
<td style="text-align:left">9</td>
<td style="text-align:left">无条件跳转。</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"><strong>jXX</strong> Dest</td>
<td style="text-align:left"><code>7fn Dest</code></td>
<td style="text-align:left">9</td>
<td style="text-align:left"><strong>条件跳转</strong>：根据条件码跳转 。<br> <code>71</code>: <strong>jle</strong> (&lt;=)<br> <code>72</code>: <strong>jl</strong> (&lt;)<br> <code>73</code>: <strong>je</strong> (=)<br> <code>74</code>: <strong>jne</strong> (!=)<br> <code>75</code>: <strong>jge</strong> (&gt;=)<br> <code>76</code>: <strong>jg</strong> (&gt;)</td>
</tr>
<tr>
<td style="text-align:left"><strong>函数调用</strong></td>
<td style="text-align:left"><strong>call</strong> Dest</td>
<td style="text-align:left"><code>80 Dest</code></td>
<td style="text-align:left">9</td>
<td style="text-align:left">将返回地址压栈，然后跳转到 Dest。</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"><strong>ret</strong></td>
<td style="text-align:left"><code>90</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">从栈中弹出返回地址，并跳转到该地址。</td>
</tr>
<tr>
<td style="text-align:left"><strong>栈操作</strong></td>
<td style="text-align:left"><strong>pushq</strong> rA</td>
<td style="text-align:left"><code>A0 rA F</code></td>
<td style="text-align:left">2</td>
<td style="text-align:left">将寄存器 <code>rA</code> 的值压入栈。注意第二个寄存器位固定为 <code>F</code> 。</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"><strong>popq</strong> rA</td>
<td style="text-align:left"><code>B0 rA F</code></td>
<td style="text-align:left">2</td>
<td style="text-align:left">从栈弹出值并存入寄存器 <code>rA</code>。注意第二个寄存器位固定为 <code>F</code> 。</td>
</tr>
</tbody>
</table>
<p>Y86-64 <strong>不支持</strong> x86-64 中的 <strong>比例变址 (scaled addressing)</strong> 寻址模式。</p>
<ul>
<li><strong>x86-64 支持：</strong> <code>D(Rb, Ri, S)</code>，即 <code>Displacement(Base, Index, Scale)</code>。例如 <code>(%rdi, %rax, 8)</code> 表示地址为 <code>R[%rdi] + R[%rax] * 8</code>。这在访问数组 <code>a[i]</code> 时非常方便。</li>
<li><strong>Y86-64 仅支持：</strong> <code>D(Rb)</code>，即 <strong>基址 + 偏移量 (Base + Displacement)</strong>。例如 <code>8(%rbp)</code> 或 <code>(%rdi)</code>。
<ul>
<li>它不支持索引寄存器（Index Register）。</li>
<li>它不支持比例因子（Scale Factor, 如 <code>*1, *2, *4, *8</code>）。</li>
</ul>
</li>
</ul>
<h2 id="编写-Y86-64-代码">编写 Y86-64 代码</h2>
<ul>
<li><strong>方法:</strong>
<ol>
<li>在 C 中编写代码。</li>
<li>使用 <code>gcc -Og -S</code> 编译为 x86-64 汇编。</li>
<li>将其“转译” (Transliterate) 为 Y86-64 汇编。</li>
</ol>
</li>
<li><strong>难点:</strong> Y86-64 没有 x86-64 的<strong>比例变址 (scaled addressing)</strong> 寻址模式（如 <code>(%rdi, %rax, 8)</code>），这使得数组索引 <code>a[i]</code> 变得困难。</li>
</ul>
<h3 id="示例：计算数组长度">示例：计算数组长度</h3>
<ul>
<li><strong>目标:</strong> 计算一个以 0 结尾的 <code>long</code> 数组的长度。</li>
<li><strong>C 语言 (指针版本):</strong></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">long</span> <span class="hljs-title function_">len</span><span class="hljs-params">(<span class="hljs-type">long</span> *a)</span> &#123;<br>    <span class="hljs-type">long</span> val = *a;<br>    <span class="hljs-type">long</span> len = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> (val) &#123;<br>        a++;       <span class="hljs-comment">// 指针加 8</span><br>        len++;<br>        val = *a;  <span class="hljs-comment">// 取下一个值</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> len;<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li><strong>Y86-64 汇编 (len):</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs y86"># %rdi = a (数组指针)<br># %rax = len (返回值)<br># %rdx = val (当前值)<br># %r8 = 1 (常量 1)<br># %r9 = 8 (常量 8)<br><br>len:<br>    irmovq $1, %r8          # Constant 1<br>    irmovq $8, %r9          # Constant 8<br>    irmovq $0, %rax         # len = 0<br>    mrmovq (%rdi), %rdx     # val = *a<br>    andq %rdx, %rdx         # Test val (设置 ZF)<br>    je Done                 # if (val == 0) goto Done<br><br>Loop:<br>    addq %r8, %rax          # len++<br>    addq %r9, %rdi          # a++ (指针移动 8 字节)<br>    mrmovq (%rdi), %rdx     # val = *a<br>    andq %rdx, %rdx         # Test val<br>    jne Loop                # if (val != 0) goto Loop<br><br>Done:<br>    ret                     # 返回<br></code></pre></td></tr></table></figure>
<h3 id="Y86-64-程序结构">Y86-64 程序结构</h3>
<p>Y86-64 程序是一个 <strong>“裸机” (Bare-metal)</strong> 程序。因为没有操作系统来加载程序或设置运行环境，程序员必须在代码中显式地定义内存布局、初始化栈指针，并手动停止处理器。</p>
<h4 id="1-完整代码结构示例">1. 完整代码结构示例</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs y86"># 第一部分：初始化代码 (Entry Point)<br># 程序必须从地址 0 开始执行<br>    .pos 0                  # 告诉汇编器，下面的代码从地址 0 开始放置<br>init:<br>    irmovq Stack, %rsp      # 【关键步骤】 初始化栈指针。<br>                            # 必须在执行任何 call/push 指令前完成。<br>                            # Stack 是底部定义的标签地址 (例如 0x100)。<br><br>    call Main               # 调用主函数 (进入业务逻辑)<br>    halt                    # 【关键步骤】 停机。<br>                            # 如果没有这条指令，CPU 会继续向下执行，<br>                            # 试图把下面的数据当作指令执行，导致错误。<br><br># 第二部分：数据段 (Data Section)<br># 存放全局变量、数组等静态数据<br>    .align 8                # 内存对齐：确保接下来的数据地址是 8 的倍数<br>array:<br>    .quad 0x111             # 定义 8字节常数 (.quad = quad word)<br>    .quad 0x222<br>    .quad 0x333<br>    .quad 0                 # 数组结束符 (类似于 C 字符串的 \0)<br><br># 第三部分：代码段 (Code Section)<br># 存放具体的函数逻辑<br><br>Main:<br>    irmovq array, %rdi      # 准备参数：将数组首地址传给第一个参数寄存器 %rdi<br>    call len                # 调用计算长度的函数<br>    ret                     # 返回 init (然后执行 halt)<br><br>len:                        # 子函数定义<br>    irmovq $1, %r8          # 常数 1<br>    irmovq $0, %rax         # sum = 0<br>    # ... (省略具体循环逻辑) ...<br>    ret<br><br># 第四部分：栈区域 (Stack Area)<br># 必须放置在内存的高地址处，远离代码和数据<br>    .pos 0x100              # 【关键指令】 将汇编地址跳转到 0x100<br>                            # 这意味着 0x100 之前的空间是空的，留给栈生长。<br><br>Stack:                      # 标签定义。<br>                            # 当执行 irmovq Stack, %rsp 时，%rsp = 0x100。<br>                            # 栈向低地址增长 (0x0F8, 0x0F0...)。<br></code></pre></td></tr></table></figure>
<h4 id="2-核心组成部分解析">2. 核心组成部分解析</h4>
<h5 id="2-1-程序的入口-init">2.1 程序的入口 (<code>init</code>)</h5>
<ul>
<li><strong><code>.pos 0</code></strong>: Y86 处理器复位后，PC (程序计数器) 默认值为 0。因此，地址 0 处必须是可以执行的代码。</li>
<li><strong><code>irmovq Stack, %rsp</code></strong>: 这是程序的第一条有效指令。
<ul>
<li>在执行 <code>call</code> 指令时，CPU 会自动将返回地址压栈。</li>
<li>如果 <code>%rsp</code> 没有初始化（或者是 0），压栈操作会导致内存错误或覆盖地址 0 处的代码。</li>
</ul>
</li>
<li><strong><code>halt</code></strong>: 程序结束的标志。在 Y86 模拟器中，这会让处理器停止运行并显示最终状态 (<code>HLT</code>)。</li>
</ul>
<h5 id="2-2-数据布局-align-quad">2.2 数据布局 (<code>.align</code> &amp; <code>.quad</code>)</h5>
<ul>
<li><strong><code>.align 8</code></strong>: Y86-64 是 64 位架构。虽然它不像某些硬件那样强制要求对齐，但为了模拟真实系统并避免跨字边界访问，通常对数据进行 8 字节对齐。</li>
<li><strong><code>.quad</code></strong>: 定义一个 64 位 (8字节) 的字。这对应于 C 语言中的 <code>long</code> 类型。</li>
<li><strong>放置位置</strong>: 数据通常放在 <code>halt</code> 之后，<code>Main</code> 之前。这样既不会被意外执行，离代码也比较近。</li>
</ul>
<h5 id="2-3-栈的设置-Stack-pos">2.3 栈的设置 (<code>Stack</code> &amp; <code>.pos</code>)</h5>
<p>栈的设计采用了 <strong>“向后定义”</strong> 的技巧：</p>
<ol>
<li><strong><code>.pos 0x100</code></strong>: 这条伪指令告诉汇编器：“不要紧接着上面的代码写了，直接跳到地址 <code>0x100</code>”。</li>
<li><strong>留白区域</strong>: 从上一个代码结束的位置到 <code>0x100</code> 之间的内存区域，就是<strong>栈空间</strong>。</li>
<li><strong><code>Stack:</code> 标签</strong>: 这个标签代表地址 <code>0x100</code>。</li>
<li><strong>生长方向</strong>:
<ul>
<li>初始 <code>%rsp</code> = <code>0x100</code>。</li>
<li>第一次 <code>push</code> 或 <code>call</code>，<code>%rsp</code> 变为 <code>0x0F8</code> (减8)。</li>
<li>栈向<strong>低地址</strong>增长，慢慢填满 <code>0x100</code> 之前的空白区。</li>
</ul>
</li>
</ol>
<div class="note note-warning 栈溢出风险">
            <p>如果栈空间预留得不够大（例如 .pos 的地址太小），或者递归调用太深，栈就会一直向低地址生长，最终覆盖掉代码段或数据段，导致程序崩溃或行为异常。</p>
          </div>
<h4 id="3-内存映像图解-Memory-Map">3. 内存映像图解 (Memory Map)</h4>
<p>这个程序的内存布局在模拟器中看起来是这样的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs Code">地址 (Address)      内容 (Content)<br>--------------------------------------<br>0x000             init 代码 (irmovq, call...)<br>...               halt 指令<br>--------------------------------------<br>(自动对齐)         数据段 (array: 0x111, 0x222...)<br>--------------------------------------<br>(紧接着数据)       Main 函数代码<br>...               len 函数代码<br>--------------------------------------<br>...               (空白内存区域)<br>...               (栈在这里动态生长)<br>...               (Stack frame n...)<br>...               (Stack frame 1...)<br>--------------------------------------<br>0x100             Stack 标签 (栈底)<br>--------------------------------------<br></code></pre></td></tr></table></figure>
<h3 id="汇编和仿真">汇编和仿真</h3>
<ol>
<li><strong>汇编 (Assembling):</strong> <code>yas len.ys</code> (Y86-64 Assembler)
<ul>
<li>生成目标文件 <code>len.yo</code>。</li>
</ul>
</li>
<li><strong>仿真 (Simulating):</strong> <code>yis len.yo</code> (Y86-64 Instruction Simulator)
<ul>
<li>执行代码，报告处理器状态的改变（寄存器、内存）和最终状态。</li>
</ul>
</li>
</ol>
<h2 id="开源指令集">开源指令集</h2>
<ul>
<li><strong>RISC-V (2016):</strong> 完全开源，架构简单，易于移植，模块化设计，低功耗。</li>
<li><strong>PowerPC (2019):</strong> 架构和指令集移交给了 Linux 基金会。</li>
</ul>
<h2 id="总结">总结</h2>
<ul>
<li><strong>Y86-64 ISA:</strong>
<ul>
<li>与 x86-64 相似的状态和指令。</li>
<li>更简单的编码。</li>
<li>介于 CISC 和 RISC 之间。</li>
</ul>
</li>
<li><strong>ISA 设计的重要性:</strong>
<ul>
<li>现在的重要性低于过去。</li>
<li>有足够强大的硬件，几乎任何 ISA 都能跑得很快。</li>
</ul>
</li>
</ul>
<h2 id="练习">练习</h2>
<h3 id="CSAPP-练习题4-1">CSAPP 练习题4.1</h3>
<p>需要用到 Y86-64 指令集的以下规则：</p>
<ol>
<li><strong>指令编码格式</strong>：
<ul>
<li><code>irmovq V, rB</code>: <code>30 F rB V</code> (10 字节)</li>
<li><code>rrmovq rA, rB</code>: <code>20 rA rB</code> (2 字节)</li>
<li><code>rmmovq rA, D(rB)</code>: <code>40 rA rB D</code> (10 字节)</li>
<li><code>addq rA, rB</code>: <code>60 rA rB</code> (2 字节)</li>
<li><code>jmp Dest</code>: <code>70 Dest</code> (9 字节)</li>
</ul>
</li>
<li><strong>寄存器 ID</strong>：
<ul>
<li><code>%rcx</code> = 1, <code>%rbx</code> = 3</li>
</ul>
</li>
<li><strong>数据格式</strong>：
<ul>
<li>立即数、偏移量、跳转地址均使用 <strong>8字节、小端法 (Little-endian)</strong> 存储。</li>
</ul>
</li>
</ol>
<table>
<thead>
<tr>
<th><strong>地址 (Address)</strong></th>
<th><strong>字节编码 (Byte Representation)</strong></th>
<th><strong>指令 (Instruction)</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>0x100</strong></td>
<td><code>30 F3 0F 00 00 00 00 00 00 00</code></td>
<td><code>irmovq $15, %rbx</code></td>
</tr>
<tr>
<td><strong>0x10A</strong></td>
<td><code>20 31</code></td>
<td><code>rrmovq %rbx, %rcx</code></td>
</tr>
<tr>
<td><strong>0x10C</strong></td>
<td><code>40 13 FD FF FF FF FF FF FF FF</code></td>
<td><code>loop: rmmovq %rcx, -3(%rbx)</code></td>
</tr>
<tr>
<td><strong>0x116</strong></td>
<td><code>60 31</code></td>
<td><code>addq %rbx, %rcx</code></td>
</tr>
<tr>
<td><strong>0x118</strong></td>
<td><code>70 0C 01 00 00 00 00 00 00</code></td>
<td><code>jmp loop</code></td>
</tr>
</tbody>
</table>
<h3 id="CSAPP-练习题4-2">CSAPP 练习题4.2</h3>
<p>这是一个关于 Y86-64 指令解码的练习题。我们需要根据指令编码规则，将每个字节序列翻译成汇编代码，并检查是否有非法指令。</p>
<p><strong>A. <code>0x100: 30f3fcffffffffffffff40630008000000000000</code></strong></p>
<p>这是一个<strong>合法</strong>的序列。</p>
<ol>
<li><strong><code>0x100: 30 f3 fcffffffffffffff</code></strong>
<ul>
<li><code>30</code>: <code>irmovq</code> 指令。</li>
<li><code>f3</code>: 源无 (<code>F</code>), 目的 <code>%rbx</code> (<code>3</code>)。</li>
<li><code>fcffffffffffffff</code>: 立即数 <code>-4</code> (0xff…fc)。</li>
<li><strong>指令</strong>: <code>irmovq $-4, %rbx</code></li>
</ul>
</li>
<li><strong><code>0x10A: 40 63 0008000000000000</code></strong>
<ul>
<li><code>40</code>: <code>rmmovq</code> 指令。</li>
<li><code>63</code>: 源 <code>%rsi</code> (<code>6</code>), 基址 <code>%rbx</code> (<code>3</code>)。</li>
<li><code>0008...</code>: 偏移量 <code>0x800</code>。</li>
<li><strong>指令</strong>: <code>rmmovq %rsi, 0x800(%rbx)</code></li>
</ul>
</li>
</ol>
<p><strong>B. <code>0x200: a06f800c0200000000000030f30a0000000000000090</code></strong></p>
<p>这是一个<strong>合法</strong>的序列。</p>
<ol>
<li><strong><code>0x200: a0 6f</code></strong>
<ul>
<li><code>a0</code>: <code>pushq</code> 指令。</li>
<li><code>6f</code>: 寄存器 <code>%rsi</code> (<code>6</code>), 填充位 <code>F</code>。</li>
<li><strong>指令</strong>: <code>pushq %rsi</code></li>
</ul>
</li>
<li><strong><code>0x202: 80 0c02000000000000</code></strong>
<ul>
<li><code>80</code>: <code>call</code> 指令。</li>
<li><code>0c02...</code>: 目标地址 <code>0x20c</code>。</li>
<li><strong>指令</strong>: <code>call 0x20c</code></li>
</ul>
</li>
<li><strong><code>0x20B: 30 f3 0a00000000000000</code></strong>
<ul>
<li><code>30</code>: <code>irmovq</code> 指令。</li>
<li><code>f3</code>: 目的 <code>%rbx</code> (<code>3</code>)。</li>
<li><code>0a...</code>: 立即数 <code>10</code>。</li>
<li><strong>指令</strong>: <code>irmovq $10, %rbx</code></li>
</ul>
</li>
<li><strong><code>0x215: 90</code></strong>
<ul>
<li><code>90</code>: <code>ret</code> 指令。</li>
<li><strong>指令</strong>: <code>ret</code></li>
</ul>
</li>
</ol>
<p><strong>C. <code>0x300: 5054070000000000000010f0b01f</code></strong></p>
<p>这是一个<strong>非法</strong>的序列。</p>
<ol>
<li><strong><code>0x300: 50 54 0700000000000000</code></strong>
<ul>
<li><code>50</code>: <code>mrmovq</code> 指令。</li>
<li><code>54</code>: 目的 <code>%rbp</code> (<code>5</code>), 基址 <code>%rsp</code> (<code>4</code>)。</li>
<li><code>07...</code>: 偏移量 <code>7</code>。</li>
<li><strong>指令</strong>: <code>mrmovq 7(%rsp), %rbp</code></li>
</ul>
</li>
<li><strong><code>0x30A: 10</code></strong>
<ul>
<li><code>10</code>: <code>nop</code> 指令。</li>
<li><strong>指令</strong>: <code>nop</code></li>
</ul>
</li>
<li><strong><code>0x30B: f0</code></strong>
<ul>
<li><strong>错误</strong>: Y86-64 指令集中没有以 <code>0xF</code> 开头的操作码。</li>
<li><strong>结论</strong>: 地址 <strong>0x30B</strong> 处出现非法字节 <code>f0</code>。</li>
</ul>
</li>
</ol>
<p><strong>D. <code>0x400: 6113730004000000000000</code></strong></p>
<p>这是一个<strong>合法</strong>的序列。</p>
<ol>
<li><strong><code>0x400: 61 13</code></strong>
<ul>
<li><code>61</code>: <code>subq</code> 指令。</li>
<li><code>13</code>: 寄存器 <code>%rcx</code> (<code>1</code>) 和 <code>%rbx</code> (<code>3</code>)。</li>
<li><strong>指令</strong>: <code>subq %rcx, %rbx</code></li>
</ul>
</li>
<li><strong><code>0x402: 73 0004000000000000</code></strong>
<ul>
<li><code>73</code>: <code>je</code> (相等则跳转) 指令。</li>
<li><code>0004...</code>: 目标地址 <code>0x400</code>。</li>
<li><strong>指令</strong>: <code>je 0x400</code></li>
</ul>
</li>
<li><strong><code>0x40B: 00</code></strong>
<ul>
<li><code>00</code>: <code>halt</code> 指令。</li>
<li><strong>指令</strong>: <code>halt</code></li>
</ul>
</li>
</ol>
<p><strong>E. <code>0x500: 6362a0f0</code></strong></p>
<p>这是一个<strong>非法</strong>的序列。</p>
<ol>
<li><strong><code>0x500: 63 62</code></strong>
<ul>
<li><code>63</code>: <code>xorq</code> 指令。</li>
<li><code>62</code>: 寄存器 <code>%rsi</code> (<code>6</code>) 和 <code>%rdx</code> (<code>2</code>)。</li>
<li><strong>指令</strong>: <code>xorq %rsi, %rdx</code></li>
</ul>
</li>
<li><strong><code>0x502: a0 f0</code></strong>
<ul>
<li><code>a0</code>: <code>pushq</code> 指令。</li>
<li><strong>错误</strong>: <code>pushq</code> 的寄存器字节格式必须是 <code>rA F</code>。
<ul>
<li>这里的第二个字节是 <code>f0</code>。</li>
<li>高位 <code>f</code> 表示寄存器 <code>rA</code> 是 <code>0xF</code> (无寄存器)，这是非法的，因为 <code>push</code> 必须操作一个有效寄存器。</li>
<li>低位 <code>0</code> 应该是 <code>F</code> (填充位)，这里却是 <code>0</code>。</li>
</ul>
</li>
<li><strong>结论</strong>: 地址 <strong>0x503</strong> (或者说指令 <code>0x502</code>) 的寄存器说明符字节 <code>f0</code> 是非法的。</li>
</ul>
</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://boginw.github.io/js-y86-64/">y86-64 Simulator</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/CSAPP/" class="category-chain-item">CSAPP</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/CSAPP/" class="print-no-link">#CSAPP</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>CSAPP - 04.ISA</div>
      <div>https://yima-gu.github.io/2026/01/14/CSAPP/04-ISA/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Yima Gu</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2026年1月15日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="NC - 非商业性使用">
                    <i class="iconfont icon-cc-nc"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="SA - 相同方式共享">
                    <i class="iconfont icon-cc-sa"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2026/01/14/CSAPP/05-Logic/" title="CSAPP - 05.Logic">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">CSAPP - 05.Logic</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2026/01/14/CSAPP/03-machine-level-4-advanced/" title="CSAPP - 03.Machine-Level Programming IV">
                        <span class="hidden-mobile">CSAPP - 03.Machine-Level Programming IV</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
    <div id="giscus" class="giscus"></div>
    <script type="text/javascript">
      Fluid.utils.loadComments('#giscus', function() {
        var options = {"repo":"Yima-Gu/Yima-Gu.github.io","repo-id":"R_kgDOPz-yyQ","category":"General","category-id":"DIC_kwDOPz-yyc4CvvD2","theme-light":"preferred_color_scheme","theme-dark":"preferred_color_scheme","mapping":"pathname","reactions-enabled":1,"emit-metadata":0,"input-position":"bottom","lang":"zh-CN"};
        var attributes = {};
        for (let option in options) {
          if (!option.startsWith('theme-')) {
            var key = option.startsWith('data-') ? option : 'data-' + option;
            attributes[key] = options[option];
          }
        }
        var light = 'preferred_color_scheme';
        var dark = 'preferred_color_scheme';
        window.GiscusThemeLight = light;
        window.GiscusThemeDark = dark;
        attributes['data-theme'] = document.documentElement.getAttribute('data-user-color-scheme') === 'dark' ? dark : light;
        for (let attribute in attributes) {
          var value = attributes[attribute];
          if (value === undefined || value === null || value === '') {
            delete attributes[attribute];
          }
        }
        var s = document.createElement('script');
        s.setAttribute('src', 'https://giscus.app/client.js');
        s.setAttribute('crossorigin', 'anonymous');
        for (let attribute in attributes) {
          s.setAttribute(attribute, attributes[attribute]);
        }
        var ss = document.getElementsByTagName('script');
        var e = ss.length > 0 ? ss[ss.length - 1] : document.head || document.documentElement;
        e.parentNode.insertBefore(s, e.nextSibling);
      });
    </script>
    <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  








    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  
<script src="/js/mermaid-init.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
